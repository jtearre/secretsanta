<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f7f7f7;
        }
        h1 {
            color: #d62828;
        }
        input, button {
            padding: 10px;
            margin: 5px;
            font-size: 1em;
        }
    </style>

    <!-- Firebase SDKs for Firebase 9.x (compat version) -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDmqZP3xBRB8rHL10S0DtpFJwvqXndaCKo",
            authDomain: "hinmaniasecretsanta.firebaseapp.com",
            projectId: "hinmaniasecretsanta",
            storageBucket: "hinmaniasecretsanta.firebasestorage.app",
            messagingSenderId: "892185417778",
            appId: "1:892185417778:web:ab3aeaa40bf7cf820d842b"
        };

        // Initialize Firebase and Firestore
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let names = [];
        let isFinalized = false;

        async function addName() {
            if (isFinalized) {
                alert("The list is finalized. No more names can be added.");
                return;
            }

            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            if (name && !names.includes(name)) {
                names.push(name);
                displayNames();
                try {
                    await db.collection('santaList').doc('names').set({ names });
                    console.log("Name added to Firestore:", name);
                } catch (error) {
                    console.error("Error adding name to Firestore:", error);
                }
            }
            nameInput.value = '';
        }

        function displayNames() {
            const nameList = document.getElementById('nameList');
            nameList.innerHTML = names.map(name => `<li>${name}</li>`).join('');
        }

        async function finalizeList() {
            if (names.length < 2) {
                alert("Add at least 2 participants before finalizing.");
                return;
            }
            isFinalized = true;

            let availableRecipients = [...names];
            const santaPairs = {};

            names.forEach(name => {
                let index;
                do {
                    index = Math.floor(Math.random() * availableRecipients.length);
                } while (availableRecipients[index] === name);

                santaPairs[name] = availableRecipients[index];
                availableRecipients.splice(index, 1);
            });

            try {
                await db.collection('santaList').doc('pairs').set(santaPairs);
                alert("The list has been finalized. Each person can now retrieve their Secret Santa!");
            } catch (error) {
                console.error("Error finalizing list:", error);
            }
        }

        async function getSecretSanta() {
            const participantName = document.getElementById('participantNameInput').value.trim();
            const santaPairsDoc = await db.collection('santaList').doc('pairs').get();
            const assignedDoc = await db.collection('santaList').doc('assigned').get();
            
            if (!santaPairsDoc.exists) {
                document.getElementById('result').innerHTML = `<p>The list has not been finalized yet.</p>`;
                return;
            }

            const santaPairs = santaPairsDoc.data();
            const alreadyAssigned = assignedDoc.exists ? assignedDoc.data() : {};

            if (alreadyAssigned[participantName]) {
                document.getElementById('result').innerHTML = `<p>You already have your Secret Santa: <strong>${alreadyAssigned[participantName]}</strong></p>`;
                return;
            }

            if (santaPairs[participantName]) {
                const recipient = santaPairs[participantName];
                document.getElementById('result').innerHTML = `<p>Your Secret Santa recipient is: <strong>${recipient}</strong></p>`;
                alreadyAssigned[participantName] = recipient;
                await db.collection('santaList').doc('assigned').set(alreadyAssigned);
            } else {
                document.getElementById('result').innerHTML = `<p>Name not found. Make sure you entered your name exactly as it was added.</p>`;
            }

            document.getElementById('participantNameInput').value = '';
        }
    </script>
</head>
<body>

<h1>Secret Santa Picker</h1>
<p>Enter each participant's name and click "Add Name". Once the list is finalized, each person can enter their name to retrieve their Secret Santa!</p>

<input type="text" id="nameInput" placeholder="Enter name">
<button onclick="addName()">Add Name</button>
<button onclick="finalizeList()">Finalize List</button>

<ul id="nameList"></ul>

<div style="margin-top: 20px;">
    <input type="text" id="participantNameInput" placeholder="Enter your name">
    <button onclick="getSecretSanta()">Give me my Secret Santa</button>
</div>

<div id="result" style="margin-top:20px;"></div>

</body>
</html>
