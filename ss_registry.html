<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SS Registry</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f7f7f7;
            padding-bottom: 50px;
        }

        h1 {
            text-align: center;
            color: #d62828;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        textarea, button {
            width: 100%;
            margin: 10px 0;
            padding: 10px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .gift-list {
            margin-top: 20px;
        }

        .gift-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .gift-item p {
            margin: 0;
            flex-grow: 1;
        }

        .gift-item button {
            margin-left: 10px;
        }

        .gift-status {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            color: #333;
            cursor: pointer;
            user-select: none;
        }

        .gift-status.nothanks {
            background-color: #ffe6e6;
        }

        .gift-status.yesplease {
            background-color: #d4ffd4;
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDmqZP3xBRB8rHL10S0DtpFJwvqXndaCKo",
            authDomain: "hinmaniasecretsanta.firebaseapp.com",
            projectId: "hinmaniasecretsanta",
            storageBucket: "hinmaniasecretsanta.firebasestorage.app",
            messagingSenderId: "892185417778",
            appId: "1:892185417778:web:ab3aeaa40bf7cf820d842b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentUser = null;
        let giftRegistry = {};
        let giftSuggestions = {};

        async function authenticate() {
            const username = prompt("Enter your name:");
            const password = prompt("Enter your password:");
            const userDoc = await db.collection('santaList').doc(username).get();

            if (!userDoc.exists || userDoc.data().password !== password) {
                alert("Invalid name or password. Access denied.");
                return false;
            }

            currentUser = username;
            loadGifts(); // Load original gift registry
            loadSuggestions(); // Load gift suggestions (separately)
            return true;
        }

        // Load and render original gift registry
        async function loadGifts() {
            const registrySnapshot = await db.collection('giftRegistry').get();
            giftRegistry = {};

            registrySnapshot.forEach(doc => {
                giftRegistry[doc.id] = doc.data().gifts || [];
            });

            renderOriginalGifts(); // Only render the original gift functionality
        }

        function renderOriginalGifts() {
            const container = document.getElementById('giftList');
            container.innerHTML = ''; // Clear container

            // Render current user's gifts
            if (giftRegistry[currentUser]) {
                const userDiv = document.createElement('div');
                userDiv.innerHTML = `<h3>My Gifts</h3>`;

                giftRegistry[currentUser]
                    .filter(gift => gift && gift.text && gift.text.trim() !== "")
                    .forEach((gift, index) => {
                        const giftItem = document.createElement('div');
                        giftItem.className = 'gift-item';

                        giftItem.innerHTML = `
                            <p>${gift.text}</p>
                            <div>
                                <button onclick="deleteGift('${currentUser}', ${index})">Delete</button>
                            </div>
                        `;

                        userDiv.appendChild(giftItem);
                    });

                container.appendChild(userDiv);
            }

            // Render gifts for other users
            Object.entries(giftRegistry).forEach(([username, gifts]) => {
                if (username === currentUser) return;

                const userDiv = document.createElement('div');
                userDiv.innerHTML = `<h3>${username}'s Gifts</h3>`;

                gifts
                    .filter(gift => gift && gift.text && gift.text.trim() !== "")
                    .forEach(gift => {
                        const giftItem = document.createElement('div');
                        giftItem.className = 'gift-item';

                        giftItem.innerHTML = `<p>${gift.text}</p>`;
                        userDiv.appendChild(giftItem);
                    });

                container.appendChild(userDiv);
            });
        }

        // Load and render gift suggestions (new functionality)
        async function loadSuggestions() {
            const suggestionsSnapshot = await db.collection('gift_suggestions').get();
            giftSuggestions = {};

            suggestionsSnapshot.forEach(doc => {
                giftSuggestions[doc.id] = doc.data().suggestions || [];
            });

            renderGiftSuggestions(); // Render gift suggestions independently
        }

        function renderGiftSuggestions() {
            const container = document.getElementById('giftSuggestions');
            container.innerHTML = ''; // Clear container

            // Render suggestions for current user
            const suggestionsForMe = giftSuggestions[currentUser] || [];
            if (suggestionsForMe.length > 0) {
                const mySuggestionsDiv = document.createElement('div');
                mySuggestionsDiv.innerHTML = `<h3>Gift Suggestions for Me</h3>`;

                suggestionsForMe.forEach((suggestion, index) => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'gift-item';

                    suggestionItem.innerHTML = `
                        <p>${suggestion.text}</p>
                        <div class="gift-status ${suggestion.status === 'YES PLEASE!' ? 'yesplease' : 'nothanks'}" 
                             onclick="toggleSuggestion('${currentUser}', ${index})">
                            ${suggestion.status || 'No Thanks Already Have!'}
                        </div>
                    `;

                    mySuggestionsDiv.appendChild(suggestionItem);
                });

                container.appendChild(mySuggestionsDiv);
            }

            // Render suggestions for other users
            Object.keys(giftRegistry).forEach(username => {
                if (username === currentUser) return;

                const suggestionsForUser = giftSuggestions[username] || [];
                const userSuggestionsDiv = document.createElement('div');
                userSuggestionsDiv.innerHTML = `<h3>Suggestions for ${username}</h3>`;

                suggestionsForUser.forEach(suggestion => {
                    const suggestionItem = document.createElement('div');
                    suggestionItem.className = 'gift-item';

                    suggestionItem.innerHTML = `
                        <p>${suggestion.text}</p>
                        <div class="gift-status ${suggestion.status === 'YES PLEASE!' ? 'yesplease' : 'nothanks'}">
                            ${suggestion.status || 'No Thanks Already Have!'}
                        </div>
                    `;

                    userSuggestionsDiv.appendChild(suggestionItem);
                });

                container.appendChild(userSuggestionsDiv);
            });
        }

        async function toggleSuggestion(username, index) {
            const suggestion = giftSuggestions[username][index];
            suggestion.status = suggestion.status === 'YES PLEASE!' ? 'No Thanks Already Have!' : 'YES PLEASE!';

            await db.collection('gift_suggestions').doc(username).set({ suggestions: giftSuggestions[username] });
            renderGiftSuggestions();
        }

        async function deleteGift(username, index) {
            const gifts = giftRegistry[username];
            gifts.splice(index, 1);

            await db.collection('giftRegistry').doc(username).set({ gifts });
            renderOriginalGifts();
        }

        window.onload = authenticate;
    </script>
</head>
<body>

<div class="container">
    <h1>Secret Santa Registry</h1>

    <!-- Original Gift List -->
    <div id="giftList" class="gift-list"></div>

    <!-- New Gift Suggestions Section -->
    <div id="giftSuggestions" class="gift-list"></div>
</div>

</body>
</html>
